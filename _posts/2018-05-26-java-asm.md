---
layout: post
title:  "ASM学习"
date:   2018-05-26 22:30
categories: 源码学习
---

ASM是一个框架，也是一些开源的jar包，主要是用于处理Java字节码的，因为Java字节码有严格的规范，所以解析起来还是比较容易的，但是由于Java规范的内容实在太多，所以处理起来还是比较麻烦。  

Java字节码的数据结构被严格规范后，解析就是按部就班的事，ASM提供了两种模型来解析，事件模型和树形模型，这个和解析XML是一样的（解析XML也是分事件模型sax和树形模型dom)，树形模型也是基于事件模型基础上的。

由于Java字节码的数据结构很固定，但是考虑到处理需求（生成和转换新的字节码）的多样性，比如有的只需要修改下某个方法，有的需要增加某个字段等等，所以ASM设计上使用了访问者模式（visitor），每一种处理方法都是一个访问者，在访问者实现类中用户可以自定义处理方法，由被访问者（这里的字节码数据结构）处理器解析字节码并生成相应事件来触发访问者的方法。

### 一些关键点
- 访问者模式
这种模式很利于处理这种数据结构固定，处理算法比较灵活多变的场景

- 链式调用
所有访问者里面包含另一个访问者，达到链式调用

- 字节处理
Java里的基本数据结构中byte是有符号的，而字节码里用的很多是无符号数据如U1，U2，U4等，要注意转换

还有Java里的字符串都是unicode的，而字节码的字符串是utf-8，也要转换

- 指令码
Java的指令码目前只有200个，分两大类，一个是操作本地变量和栈之间交换的（如将本地变量推入栈x_load，或者将栈中元素推出存入本地变量x_store，另一类就是对栈中元素处理的。 每个指令都有其类型区分

- 通过字节码的学习也了解到诸如ruby，javascript，python等高级语言其实都是先编译成字节码，然后通过虚拟机引擎来解析执行的。 


